# Feature 0004: Freemium Business Model

## Context
Implement a freemium business model with subscription tiers that leverages in-app payment capabilities. The system will segregate user access based on subscription levels, providing different feature sets and usage limits for free vs premium users.

**Prerequisite**: Features 0000, 0001, 0002, 0003 should be completed first.

**MVP Scope**: Basic subscription tiers, usage tracking, feature gating, in-app purchases.

## Technical Plan

### Phase 1: Data Layer & Subscription Schema

#### Database Schema Changes
- **File**: `supabase/migrations/004_create_subscriptions_table.sql`
- **Changes**: Create subscription and usage tracking tables
```sql
-- Subscription plans table
CREATE TABLE subscription_plans (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  display_name TEXT NOT NULL,
  description TEXT,
  price_monthly DECIMAL(10,2),
  price_yearly DECIMAL(10,2),
  features JSONB NOT NULL,
  limits JSONB NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- User subscriptions table
CREATE TABLE user_subscriptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  plan_id UUID REFERENCES subscription_plans(id),
  status TEXT NOT NULL CHECK (status IN ('active', 'canceled', 'past_due', 'unpaid')),
  current_period_start TIMESTAMP WITH TIME ZONE,
  current_period_end TIMESTAMP WITH TIME ZONE,
  cancel_at_period_end BOOLEAN DEFAULT false,
  payment_provider TEXT NOT NULL, -- 'apple', 'google', 'stripe'
  payment_provider_subscription_id TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Usage tracking table
CREATE TABLE user_usage (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  usage_type TEXT NOT NULL, -- 'discoveries', 'ai_processing', 'storage'
  usage_count INTEGER DEFAULT 0,
  usage_limit INTEGER NOT NULL,
  reset_date DATE NOT NULL, -- monthly reset
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, usage_type, reset_date)
);

-- Add subscription info to discoveries table
ALTER TABLE discoveries ADD COLUMN subscription_tier TEXT DEFAULT 'free';
ALTER TABLE discoveries ADD COLUMN usage_tracked BOOLEAN DEFAULT false;

-- Indexes
CREATE INDEX idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_status ON user_subscriptions(status);
CREATE INDEX idx_user_usage_user_id ON user_usage(user_id);
CREATE INDEX idx_user_usage_type_date ON user_usage(usage_type, reset_date);
```

#### Type Definitions
- **File**: `types/subscription.ts`
- **Changes**: Define TypeScript interfaces for subscription system
```typescript
interface SubscriptionPlan {
  id: string;
  name: string;
  display_name: string;
  description: string;
  price_monthly: number;
  price_yearly: number;
  features: SubscriptionFeatures;
  limits: SubscriptionLimits;
  is_active: boolean;
}

interface SubscriptionFeatures {
  unlimited_discoveries: boolean;
  advanced_search: boolean;
  export_data: boolean;
  priority_processing: boolean;
  custom_categories: boolean;
  analytics: boolean;
  api_access: boolean;
}

interface SubscriptionLimits {
  monthly_discoveries: number;
  monthly_ai_processing: number;
  storage_gb: number;
  search_history: number;
}

interface UserSubscription {
  id: string;
  user_id: string;
  plan_id: string;
  status: 'active' | 'canceled' | 'past_due' | 'unpaid';
  current_period_start: string;
  current_period_end: string;
  cancel_at_period_end: boolean;
  payment_provider: 'apple' | 'google' | 'stripe';
  payment_provider_subscription_id: string;
  plan?: SubscriptionPlan;
}

interface UserUsage {
  id: string;
  user_id: string;
  usage_type: 'discoveries' | 'ai_processing' | 'storage';
  usage_count: number;
  usage_limit: number;
  reset_date: string;
}
```

### Phase 2: Subscription Management UI

#### Subscription Plans Screen
- **File**: `app/(tabs)/subscription.tsx`
- **Changes**: Create subscription management screen
- **Components**:
  - Current plan display
  - Available plans comparison
  - Upgrade/downgrade buttons
  - Usage statistics
  - Billing history
  - Cancel subscription option

#### Plan Comparison Component
- **File**: `components/subscription/PlanComparison.tsx`
- **Changes**: Create plan comparison component
- **Features**:
  - Feature comparison table
  - Pricing display
  - Upgrade/downgrade CTAs
  - Popular plan highlighting

#### Usage Dashboard Component
- **File**: `components/subscription/UsageDashboard.tsx`
- **Changes**: Create usage tracking component
- **Features**:
  - Monthly usage progress bars
  - Usage breakdown by type
  - Reset date information
  - Upgrade prompts when near limits

### Phase 3: Payment Integration Services

#### In-App Purchase Service
- **File**: `services/paymentService.ts`
- **Changes**: Create service for in-app purchases
```typescript
- initializePayments(): Promise<void>
- getAvailableProducts(): Promise<Product[]>
- purchaseSubscription(productId: string): Promise<PurchaseResult>
- restorePurchases(): Promise<PurchaseResult[]>
- cancelSubscription(): Promise<void>
- getSubscriptionStatus(): Promise<SubscriptionStatus>
```

#### Subscription Management Service
- **File**: `services/subscriptionService.ts`
- **Changes**: Create service for subscription management
```typescript
- getCurrentSubscription(): Promise<UserSubscription | null>
- getAvailablePlans(): Promise<SubscriptionPlan[]>
- upgradeSubscription(planId: string): Promise<void>
- cancelSubscription(): Promise<void>
- getUsageStats(): Promise<UserUsage[]>
- checkFeatureAccess(feature: string): Promise<boolean>
- incrementUsage(usageType: string): Promise<void>
```

### Phase 4: Access Control & Usage Tracking

#### Access Control Service
- **File**: `services/accessControlService.ts`
- **Changes**: Create service for feature access control
```typescript
- canCreateDiscovery(): Promise<boolean>
- canUseAdvancedSearch(): Promise<boolean>
- canExportData(): Promise<boolean>
- canUsePriorityProcessing(): Promise<boolean>
- canUseCustomCategories(): Promise<boolean>
- canAccessAnalytics(): Promise<boolean>
- canUseAPI(): Promise<boolean>
- getRemainingUsage(usageType: string): Promise<number>
```

#### Usage Tracking Service
- **File**: `services/usageTrackingService.ts`
- **Changes**: Create service for usage tracking
```typescript
- trackDiscoveryCreation(): Promise<void>
- trackAIProcessing(): Promise<void>
- trackStorageUsage(bytes: number): Promise<void>
- trackSearchUsage(): Promise<void>
- getUsageForPeriod(usageType: string, period: string): Promise<UserUsage>
- resetUsageIfNeeded(): Promise<void>
```

### Phase 5: State Management

#### Subscription Store
- **File**: `stores/subscriptionStore.ts`
- **Changes**: Create Zustand store for subscription state
```typescript
interface SubscriptionStore {
  currentSubscription: UserSubscription | null;
  availablePlans: SubscriptionPlan[];
  usageStats: UserUsage[];
  isLoading: boolean;
  error: string | null;
  
  // Actions
  fetchCurrentSubscription: () => Promise<void>;
  fetchAvailablePlans: () => Promise<void>;
  fetchUsageStats: () => Promise<void>;
  upgradeSubscription: (planId: string) => Promise<void>;
  cancelSubscription: () => Promise<void>;
  checkFeatureAccess: (feature: string) => boolean;
  trackUsage: (usageType: string) => Promise<void>;
}
```

### Phase 6: Integration & Feature Gating

#### Feature Gating Components
- **File**: `components/subscription/FeatureGate.tsx`
- **Changes**: Create component for feature gating
- **Features**:
  - Conditional rendering based on subscription
  - Upgrade prompts for locked features
  - Usage limit warnings
  - Graceful degradation

#### Discovery Creation Integration
- **File**: `app/(tabs)/create.tsx`
- **Changes**: Integrate subscription limits
- **Features**:
  - Check discovery creation limits
  - Show upgrade prompt when limit reached
  - Track usage after creation
  - Premium features (priority processing, custom categories)

#### Timeline Integration
- **File**: `app/(tabs)/index.tsx`
- **Changes**: Integrate subscription features
- **Features**:
  - Advanced search for premium users
  - Export functionality
  - Analytics dashboard
  - Unlimited discoveries

## Algorithms

### Subscription Validation Flow
1. **User Action**: User attempts to access feature
2. **Access Check**: Verify subscription status and limits
3. **Usage Validation**: Check current usage against limits
4. **Feature Gate**: Allow/deny access based on subscription
5. **Upgrade Prompt**: Show upgrade option if access denied
6. **Usage Tracking**: Track usage if action is allowed

### Payment Processing Flow
1. **Product Selection**: User selects subscription plan
2. **Payment Initiation**: Initialize payment with platform
3. **Purchase Validation**: Validate purchase with platform
4. **Receipt Verification**: Verify receipt with backend
5. **Subscription Update**: Update user subscription in database
6. **Feature Unlock**: Unlock premium features immediately
7. **Usage Reset**: Reset usage limits for new period

### Usage Tracking Algorithm
1. **Action Detection**: Detect user action that requires tracking
2. **Limit Check**: Verify user hasn't exceeded limits
3. **Usage Increment**: Increment usage counter
4. **Database Update**: Update usage in database
5. **Limit Warning**: Show warning when approaching limits
6. **Period Reset**: Reset usage at start of new period

## Files to Create/Modify

### New Files
- `app/(tabs)/subscription.tsx`
- `components/subscription/PlanComparison.tsx`
- `components/subscription/UsageDashboard.tsx`
- `components/subscription/FeatureGate.tsx`
- `services/paymentService.ts`
- `services/subscriptionService.ts`
- `services/accessControlService.ts`
- `services/usageTrackingService.ts`
- `stores/subscriptionStore.ts`
- `types/subscription.ts`

### Modified Files
- `app/(tabs)/create.tsx` - Add subscription limits
- `app/(tabs)/index.tsx` - Add premium features
- `app/(tabs)/_layout.tsx` - Add subscription tab
- `services/discoveryService.ts` - Add usage tracking
- `stores/discoveryStore.ts` - Add subscription checks
- `package.json` - Add payment dependencies

### Dependencies to Add
```json
{
  "expo-in-app-purchases": "latest",
  "expo-device": "latest",
  "expo-constants": "latest",
  "expo-secure-store": "latest"
}
```

## Success Criteria
- [ ] Users can view subscription plans
- [ ] Users can upgrade to premium plans
- [ ] Usage limits are enforced
- [ ] Premium features are gated appropriately
- [ ] Usage tracking works correctly
- [ ] Payment processing is secure
- [ ] Subscription status persists across app restarts
- [ ] Upgrade prompts are shown when limits are reached 