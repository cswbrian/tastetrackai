# Feature 0003: Search and Filtering

## Context
Implement search and filtering capabilities for discoveries, allowing users to find past discoveries using text search, categories, and discovery types. This feature enhances the discovery management experience.

**Prerequisite**: Feature 0002 (LLM Integration) should be completed first for enhanced search capabilities.

**MVP Scope**: Basic search, category filtering, discovery type filtering, enhanced search with extracted data.

## Technical Plan

### Phase 1: Database Schema Updates

#### Search Indexes
- **File**: `supabase/migrations/003_add_search_support.sql`
- **Changes**: Add search indexes and full-text search support
```sql
-- Add full-text search index for text_content
CREATE INDEX idx_discoveries_text_search ON discoveries USING GIN (to_tsvector('english', text_content));

-- Add index for discovery_type for faster filtering
CREATE INDEX idx_discoveries_type ON discoveries(discovery_type);

-- Add index for category for faster filtering
CREATE INDEX idx_discoveries_category ON discoveries(category);

-- Add full-text search function for extracted data
CREATE OR REPLACE FUNCTION search_discoveries(search_query TEXT, user_id UUID)
RETURNS TABLE (
  id UUID,
  text_content TEXT,
  category TEXT,
  discovery_type TEXT,
  image_url TEXT,
  extracted_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE,
  rank REAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    d.id,
    d.text_content,
    d.category,
    d.discovery_type,
    d.image_url,
    d.extracted_data,
    d.created_at,
    ts_rank(to_tsvector('english', d.text_content), plainto_tsquery('english', search_query)) as rank
  FROM discoveries d
  WHERE d.user_id = search_discoveries.user_id
    AND (
      to_tsvector('english', d.text_content) @@ plainto_tsquery('english', search_query)
      OR d.extracted_data::text ILIKE '%' || search_query || '%'
    )
  ORDER BY rank DESC, d.created_at DESC;
END;
$$ LANGUAGE plpgsql;
```

### Phase 2: Search Service

#### Search Service
- **File**: `services/searchService.ts`
- **Changes**: Create service for search and filtering
```typescript
- searchDiscoveries(query: string): Promise<Discovery[]>
- filterByCategory(category: string): Promise<Discovery[]>
- filterByType(type: string): Promise<Discovery[]>
- filterByDateRange(startDate: Date, endDate: Date): Promise<Discovery[]>
- getSearchSuggestions(query: string): Promise<string[]>
- getFilterOptions(): Promise<FilterOptions>
```

#### Enhanced Discovery Service
- **File**: `services/discoveryService.ts`
- **Changes**: Add search capabilities
```typescript
- searchDiscoveries(query: string, filters?: SearchFilters): Promise<Discovery[]>
- getDiscoveriesWithFilters(filters?: SearchFilters): Promise<Discovery[]>
```

### Phase 3: UI Components

#### Search Bar Component
- **File**: `components/search/SearchBar.tsx`
- **Changes**: Create search input component
- **Features**:
  - Search input with clear button
  - Search suggestions
  - Real-time search
  - Search history

#### Filter Panel Component
- **File**: `components/search/FilterPanel.tsx`
- **Changes**: Create filter selection component
- **Features**:
  - Category filter buttons
  - Discovery type dropdown
  - Date range picker
  - Clear filters option

#### Search Results Component
- **File**: `components/search/SearchResults.tsx`
- **Changes**: Create search results display
- **Features**:
  - Search result highlighting
  - Result count display
  - No results state
  - Loading state

### Phase 4: State Management

#### Search Store
- **File**: `stores/searchStore.ts`
- **Changes**: Create store for search state
```typescript
interface SearchStore {
  searchQuery: string;
  filters: SearchFilters;
  searchResults: Discovery[];
  isLoading: boolean;
  searchHistory: string[];
  
  // Actions
  search: (query: string) => Promise<void>;
  setFilters: (filters: SearchFilters) => Promise<void>;
  clearSearch: () => void;
  clearFilters: () => void;
  addToHistory: (query: string) => void;
}

interface SearchFilters {
  category?: string;
  discoveryType?: string;
  dateRange?: {
    start: Date;
    end: Date;
  };
}
```

#### Enhanced Discovery Store
- **File**: `stores/discoveryStore.ts`
- **Changes**: Add search capabilities
```typescript
interface DiscoveryStore {
  discoveries: Discovery[];
  searchResults: Discovery[];
  isLoading: boolean;
  searchQuery: string;
  filters: SearchFilters;
  
  // Actions
  createDiscovery: (data: DiscoveryInput) => Promise<void>;
  fetchDiscoveries: () => Promise<void>;
  searchDiscoveries: (query: string, filters?: SearchFilters) => Promise<void>;
  clearSearch: () => void;
}
```

### Phase 5: Integration

#### Enhanced Timeline
- **File**: `app/(tabs)/index.tsx`
- **Changes**: Add search and filtering to timeline
- **Features**:
  - Search bar at top
  - Filter buttons
  - Search results display
  - Toggle between all discoveries and search results

#### Search Tab
- **File**: `app/(tabs)/search.tsx`
- **Changes**: Create dedicated search screen
- **Features**:
  - Full-screen search experience
  - Advanced filters
  - Search history
  - Search suggestions

## Algorithms

### Search Algorithm
1. **Query Processing**: Parse search query into keywords
2. **Text Search**: Search across text_content using full-text search
3. **Extracted Data Search**: Search across extracted_data JSON
4. **Filter Application**: Apply category, type, and date filters
5. **Result Ranking**: Rank results by relevance and date
6. **Pagination**: Return paginated results

### Filter Algorithm
1. **Filter Selection**: User selects filter criteria
2. **Query Building**: Build database query with filters
3. **Database Query**: Execute filtered query
4. **Result Processing**: Process and format results
5. **UI Update**: Update UI with filtered results

### Search Suggestions
1. **Query Analysis**: Analyze partial search query
2. **History Lookup**: Check search history for matches
3. **Discovery Lookup**: Find matching discovery content
4. **Suggestion Generation**: Generate relevant suggestions
5. **Ranking**: Rank suggestions by relevance

## Files to Create/Modify

### New Files
- `services/searchService.ts`
- `components/search/SearchBar.tsx`
- `components/search/FilterPanel.tsx`
- `components/search/SearchResults.tsx`
- `stores/searchStore.ts`
- `app/(tabs)/search.tsx`

### Modified Files
- `services/discoveryService.ts` - Add search capabilities
- `stores/discoveryStore.ts` - Add search state
- `app/(tabs)/index.tsx` - Add search bar and filters
- `app/(tabs)/_layout.tsx` - Add search tab

## Success Criteria
- [ ] Users can search discoveries by text
- [ ] Search includes extracted data from LLM
- [ ] Users can filter by category and discovery type
- [ ] Search results are ranked by relevance
- [ ] Search history is maintained
- [ ] Search suggestions are provided
- [ ] Search performance is fast (< 1 second)
- [ ] Search works offline with cached results 