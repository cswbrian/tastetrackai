# Feature 0001: Basic Discovery Creation (MVP)

## Context
Implement core discovery creation functionality that allows users to write notes, add multiple photos, and categorize experiences. Each discovery must have either text content or at least one photo. This is the primary feature that defines the app's value proposition.

**Prerequisite**: Feature 0000 (Authentication) must be completed first.

**MVP Scope**: Basic discovery creation with multiple images, simple timeline view, core database operations with future scalability preparation.

## Technical Plan

### Phase 1: Data Layer & Types

#### Database Schema Changes
- **File**: `supabase/migrations/001_create_discoveries_table.sql`
- **Changes**: Create discoveries table with multiple images support and location data
```sql
CREATE TABLE discoveries (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  text_content TEXT,
  category TEXT NOT NULL CHECK (category IN ('liked_it', 'didnt_like_it', 'want_to_try')),
  discovery_type TEXT,
  location_lat DECIMAL(10, 8),
  location_lng DECIMAL(11, 8),
  location_name TEXT,
  location_source TEXT CHECK (location_source IN ('gps', 'exif', 'manual', 'none')),
  -- Future LLM support (MVP: NULL, Future: JSONB)
  extracted_data JSONB,
  -- Future queue support (MVP: NULL, Future: status tracking)
  processing_status TEXT DEFAULT 'pending' CHECK (processing_status IN ('pending', 'processing', 'completed', 'failed')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  -- Constraint: Must have either text or images
  CONSTRAINT discovery_content_check CHECK (
    text_content IS NOT NULL AND text_content != '' OR 
    EXISTS (SELECT 1 FROM discovery_images WHERE discovery_id = id)
  )
);

CREATE TABLE discovery_images (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  discovery_id UUID REFERENCES discoveries(id) ON DELETE CASCADE,
  image_url TEXT NOT NULL,
  image_order INTEGER NOT NULL DEFAULT 0,
  exif_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_discoveries_user_id ON discoveries(user_id);
CREATE INDEX idx_discoveries_created_at ON discoveries(created_at DESC);
CREATE INDEX idx_discoveries_location ON discoveries(location_lat, location_lng);
CREATE INDEX idx_discoveries_location_source ON discoveries(location_source);
CREATE INDEX idx_discovery_images_discovery_id ON discovery_images(discovery_id);
CREATE INDEX idx_discovery_images_order ON discovery_images(discovery_id, image_order);
-- Future indexes (commented for MVP)
-- CREATE INDEX idx_discoveries_processing_status ON discoveries(processing_status);
-- CREATE INDEX idx_discoveries_extracted_data ON discoveries USING GIN (extracted_data);
```

#### Basic Type Definitions
- **File**: `types/discovery.ts`
- **Changes**: Define essential TypeScript interfaces with multiple images support
```typescript
interface Discovery {
  id: string;
  user_id: string;
  text_content?: string;
  category: 'liked_it' | 'didnt_like_it' | 'want_to_try';
  discovery_type?: string;
  images: DiscoveryImage[];
  location_lat?: number;
  location_lng?: number;
  location_name?: string;
  location_source?: 'gps' | 'exif' | 'manual' | 'none';
  // Future LLM support
  extracted_data?: ExtractedData;
  processing_status?: 'pending' | 'processing' | 'completed' | 'failed';
  created_at: string;
  updated_at: string;
}

interface DiscoveryImage {
  id: string;
  discovery_id: string;
  image_url: string;
  image_order: number;
  exif_data?: Record<string, any>;
  created_at: string;
}

interface DiscoveryInput {
  text_content?: string;
  category: 'liked_it' | 'didnt_like_it' | 'want_to_try';
  discovery_type?: string;
  images?: File[];
  location_lat?: number;
  location_lng?: number;
  location_name?: string;
  location_source?: 'gps' | 'exif' | 'manual' | 'none';
}

interface LocationData {
  latitude: number;
  longitude: number;
  name?: string;
  source: 'gps' | 'exif' | 'manual' | 'none';
}

// Future LLM types (commented for MVP)
/*
interface ExtractedData {
  keywords: string[];
  entities: Record<string, string>;
  sub_types: string[];
  confidence_scores: Record<string, number>;
}
*/
```

### Phase 2: Core UI Components

#### Discovery Creation Screen
- **File**: `app/(tabs)/create.tsx`
- **Changes**: Create basic discovery creation screen with multiple image support
- **Components**:
  - Text input for notes (optional)
  - Multiple photo capture/selection with image gallery preview
  - Image reordering capability
  - Image deletion capability
  - Category selection (Liked It, Didn't Like It, Want to Try)
  - Discovery type dropdown (Book, Music, Movie, Food, Drink, Place, Product)
  - Location capture indicator (GPS/EXIF/Manual)
  - Location name display (if available)
  - Manual location edit option
  - Save button with loading state and validation (requires text OR images)
  - Future: Processing status indicator (commented for MVP)

#### Discovery Card Component
- **File**: `components/discovery/DiscoveryCard.tsx`
- **Changes**: Create basic discovery card component with multiple image support
- **Features**:
  - Multiple photo display with carousel/gallery view
  - Text snippet (if available)
  - Category badge
  - Timestamp
  - Location display (if available)
  - Image count indicator
  - Future: Extracted data display (commented for MVP)
  - Future: Processing status indicator (commented for MVP)

#### Discoveries Screen (Timeline View)
- **File**: `app/(tabs)/discoveries.tsx`
- **Changes**: Create discoveries screen with timeline view as default
- **Features**:
  - Chronological list of discoveries
  - Pull-to-refresh
  - Floating action button to create
  - Future: View toggle (timeline/grid/map) (commented for MVP)
  - Future: Search bar (commented for MVP)
  - Future: Filter buttons (commented for MVP)

### Phase 3: Core Services

#### Basic Discovery Service
- **File**: `services/discoveryService.ts`
- **Changes**: Create essential CRUD operations with multiple image support
```typescript
- createDiscovery(data: DiscoveryInput): Promise<Discovery>
- getDiscoveries(): Promise<Discovery[]>
- updateDiscovery(id: string, data: Partial<Discovery>): Promise<Discovery>
- deleteDiscovery(id: string): Promise<void>
- getDiscoveryById(id: string): Promise<Discovery | null>
- addImagesToDiscovery(discoveryId: string, images: File[]): Promise<DiscoveryImage[]>
- removeImageFromDiscovery(imageId: string): Promise<void>
- reorderImages(discoveryId: string, imageOrder: {id: string, order: number}[]): Promise<void>

// Future methods (commented for MVP)
/*
- createDiscoveryWithLLM(data: DiscoveryInput): Promise<Discovery>
- getDiscoveriesWithFilters(filters: FilterOptions): Promise<Discovery[]>
- searchDiscoveries(query: string): Promise<Discovery[]>
*/
```

#### Basic Image Service
- **File**: `services/imageService.ts`
- **Changes**: Create basic image handling with multiple image support and EXIF extraction
```typescript
- uploadImages(files: File[]): Promise<string[]>
- uploadImage(file: File): Promise<string>
- compressImage(image: ImageSource): Promise<File>
- compressImages(images: ImageSource[]): Promise<File[]>
- extractEXIFLocation(image: File): Promise<LocationData | null>
- extractEXIFFromImages(images: File[]): Promise<Record<string, LocationData>>
- getImageMetadata(image: File): Promise<ImageMetadata>
- validateImageFile(file: File): boolean
```

#### Location Service
- **File**: `services/locationService.ts`
- **Changes**: Create service for location handling
```typescript
- getCurrentLocation(): Promise<LocationData>
- requestLocationPermission(): Promise<boolean>
- reverseGeocode(lat: number, lng: number): Promise<string>
- validateLocation(lat: number, lng: number): boolean
- getLocationFromEXIF(image: File): Promise<LocationData | null>
```

### Phase 4: State Management

#### Basic Discovery Store
- **File**: `stores/discoveryStore.ts`
- **Changes**: Create basic Zustand store with future scalability
```typescript
interface DiscoveryStore {
  discoveries: Discovery[];
  isLoading: boolean;
  error: string | null;
  
  // Actions
  createDiscovery: (data: DiscoveryInput) => Promise<void>;
  fetchDiscoveries: () => Promise<void>;
  updateDiscovery: (id: string, data: Partial<Discovery>) => Promise<void>;
  deleteDiscovery: (id: string) => Promise<void>;
  clearError: () => void;
  
  // Future actions (commented for MVP)
  /*
  retryProcessing: (discoveryId: string) => Promise<void>;
  searchDiscoveries: (query: string) => Promise<void>;
  filterDiscoveries: (filters: FilterOptions) => Promise<void>;
  */
}
```

### Phase 5: Integration

#### Navigation Updates
- **File**: `app/(tabs)/_layout.tsx`
- **Changes**: Add create tab
```typescript
- Add create tab with plus icon
- Update existing tab icons
- Future: Add search tab (commented for MVP)
```

#### Basic Form Validation
- **File**: `schemas/discoverySchema.ts`
- **Changes**: Create basic Zod schema with content requirement validation
```typescript
- Text content validation (optional, max length)
- Images validation (optional, array of files)
- Content requirement validation (must have text OR at least one image)
- Category validation (enum)
- Discovery type validation (optional enum)
- Location validation (optional coordinates)
- Image validation (file size/type, max count)
```

## Algorithms

### Basic Discovery Creation Flow
1. **User Input**: Text (optional), multiple photos, category, type
2. **Content Validation**: Ensure either text or at least one photo is provided
3. **Location Capture**: Automatically capture GPS location or extract from EXIF
4. **Local Validation**: Client-side form validation
5. **Image Processing**: Compress and upload multiple images to Supabase Storage
6. **Discovery Save**: Save to Supabase database with location data and image references
7. **UI Update**: Refresh timeline with new discovery

### Location Capture Algorithm
1. **Permission Check**: Request location permission if not granted
2. **GPS Capture**: Try to get current GPS location
3. **EXIF Fallback**: If GPS fails, extract location from photo EXIF
4. **Manual Option**: Allow user to manually set location if needed
5. **Reverse Geocoding**: Convert coordinates to readable location name
6. **Data Storage**: Save location with source tracking

### Basic Image Processing
1. **Capture/Selection**: Use Expo Camera or Image Picker for multiple images
2. **Validation**: Check file size, type, and count limits
3. **Compression**: Resize and compress all images
4. **EXIF Extraction**: Extract location data from all images
5. **Upload**: Upload all images to Supabase Storage bucket
6. **URL Generation**: Get public URLs for all images
7. **Database Storage**: Store image references with order in discovery_images table

## Files to Create/Modify

### New Files
- `app/(tabs)/create.tsx`
- `components/discovery/DiscoveryCard.tsx`
- `services/discoveryService.ts`
- `services/imageService.ts`
- `services/locationService.ts`
- `stores/discoveryStore.ts`
- `types/discovery.ts`
- `schemas/discoverySchema.ts`

### Modified Files
- `app/(tabs)/discoveries.tsx` - Create discoveries screen with timeline view
- `app/(tabs)/_layout.tsx` - Add create tab and update navigation
- `package.json` - Add new dependencies
- `app.json` - Add camera and location permissions

### Dependencies to Add
```json
{
  "expo-camera": "latest",
  "expo-image-picker": "latest",
  "expo-location": "latest",
  "exif-reader": "latest",
  "react-hook-form": "latest",
  "@hookform/resolvers": "latest",
  "zod": "latest"
}
```

## Success Criteria
- [ ] Users can create discoveries with text (optional) and multiple photos
- [ ] Each discovery must have either text content or at least one photo
- [ ] Users can add, remove, and reorder images in discovery creation
- [ ] Users can categorize discoveries (Liked It, Didn't Like It, Want to Try)
- [ ] Users can select discovery types
- [ ] Location is automatically captured (GPS or EXIF from any image)
- [ ] Users can manually edit location if needed
- [ ] Location data is stored with source tracking
- [ ] Discoveries appear in chronological timeline view with image galleries
- [ ] Users can refresh discoveries to see new items
- [ ] Multiple image upload works correctly with proper ordering
- [ ] Form validation prevents invalid submissions (requires text OR images)
- [ ] Database schema supports multiple images with proper relationships
- [ ] Type definitions support multiple images and future enhancements 