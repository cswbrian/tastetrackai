# Feature 0002: LLM Integration for Discovery Enhancement (MVP)

## Context
Implement AI-powered data extraction from discoveries using LLM processing. This feature will automatically extract structured data from user's text and photos, enhancing the discovery experience with intelligent insights.

**Prerequisite**: Feature 0001 (Basic Discovery Creation) must be completed first.

**MVP Scope**: Immediate LLM processing, entity extraction, enhanced discovery display with future queue system preparation.

## Technical Plan

### Phase 1: Database Schema Updates

#### Enhanced Discovery Schema
- **File**: `supabase/migrations/002_add_llm_support.sql`
- **Changes**: Add LLM processing support to discoveries table (MVP: immediate processing)
```sql
-- Add LLM processing columns to discoveries table
ALTER TABLE discoveries ADD COLUMN extracted_data JSONB;
ALTER TABLE discoveries ADD COLUMN processing_status TEXT DEFAULT 'pending' CHECK (processing_status IN ('pending', 'processing', 'completed', 'failed'));

-- Add index for processing status
CREATE INDEX idx_discoveries_processing_status ON discoveries(processing_status);
CREATE INDEX idx_discoveries_extracted_data ON discoveries USING GIN (extracted_data);

-- Future: Queue-related indexes (commented for MVP)
-- CREATE INDEX idx_discoveries_queue_id ON discoveries(queue_id);
-- CREATE INDEX idx_discoveries_sync_status ON discoveries(sync_status);
```

#### Enhanced Type Definitions
- **File**: `types/discovery.ts`
- **Changes**: Add LLM-related types with future queue preparation
```typescript
interface ExtractedData {
  keywords: string[];
  entities: Record<string, string>;
  sub_types: string[];
  confidence_scores: Record<string, number>;
}

interface Discovery {
  id: string;
  user_id: string;
  text_content: string;
  category: 'liked_it' | 'didnt_like_it' | 'want_to_try';
  discovery_type?: string;
  image_url?: string;
  location_lat?: number;
  location_lng?: number;
  location_name?: string;
  location_source?: 'gps' | 'exif' | 'manual' | 'none';
  extracted_data?: ExtractedData;
  processing_status: 'pending' | 'processing' | 'completed' | 'failed';
  created_at: string;
  updated_at: string;
  
  // Future queue support (commented for MVP)
  // queue_id?: string;
  // sync_status?: 'synced' | 'pending' | 'conflict';
  // local_id?: string;
}

// Future queue types (commented for MVP)
/*
interface QueueItem {
  id: string;
  discovery_id: string;
  user_id: string;
  queue_type: 'llm_processing' | 'image_analysis' | 'location_enhancement';
  status: 'queued' | 'processing' | 'completed' | 'failed' | 'retry';
  priority: number;
  retry_count: number;
  max_retries: number;
  payload: any;
  error_message?: string;
  created_at: string;
}
*/
```

### Phase 2: LLM Service Integration

#### LLM Service
- **File**: `services/llmService.ts`
- **Changes**: Create service for AI processing with MVP immediate processing
```typescript
- processDiscoveryWithLLM(discovery: DiscoveryInput): Promise<ExtractedData>
- createExtractionPrompt(text: string, imageUrl?: string): string
- parseLLMResponse(response: string): ExtractedData
- validateExtractedData(data: ExtractedData): boolean
- handleLLMError(error: Error, retryCount: number): Promise<boolean>

// Future queue methods (commented for MVP)
/*
- processFromQueue(queueItem: QueueItem): Promise<ProcessingResult>
- addToQueue(discoveryId: string): Promise<void>
- getQueueStatus(discoveryId: string): Promise<string>
*/
```

#### Enhanced Discovery Service
- **File**: `services/discoveryService.ts`
- **Changes**: Add LLM processing to discovery creation (MVP: immediate processing)
```typescript
- createDiscoveryWithLLM(data: DiscoveryInput): Promise<Discovery>
- updateDiscoveryWithLLM(id: string, data: Partial<Discovery>): Promise<Discovery>
- getProcessingStatus(discoveryId: string): Promise<string>
- retryLLMProcessing(discoveryId: string): Promise<void>

// Future queue methods (commented for MVP)
/*
- createDiscoveryWithQueue(data: DiscoveryInput): Promise<Discovery>
- processQueue(): Promise<void>
- getQueueItems(): Promise<QueueItem[]>
*/
```

### Phase 3: UI Enhancements

#### Enhanced Discovery Card
- **File**: `components/discovery/DiscoveryCard.tsx`
- **Changes**: Add extracted data display with processing status
- **Features**:
  - Show extracted entities (keywords, entities)
  - Processing status indicator
  - Loading state for processing
  - Fallback for failed processing
  - Retry button for failed processing
  - Future: Queue status indicator (commented for MVP)

#### Processing Status Component
- **File**: `components/discovery/ProcessingStatus.tsx`
- **Changes**: Create processing status indicator
- **Features**:
  - Visual processing status
  - Progress indicators
  - Error states
  - Retry functionality
  - Future: Queue-specific status (commented for MVP)

#### Enhanced Discovery Creation
- **File**: `app/(tabs)/create.tsx`
- **Changes**: Add LLM processing to creation flow (MVP: immediate processing)
- **Features**:
  - Show processing status after save
  - Handle LLM processing errors
  - Provide feedback during processing
  - Retry option for failed processing
  - Future: Queue-based processing (commented for MVP)

### Phase 4: State Management Updates

#### Enhanced Discovery Store
- **File**: `stores/discoveryStore.ts`
- **Changes**: Add LLM processing state with future queue preparation
```typescript
interface DiscoveryStore {
  discoveries: Discovery[];
  isLoading: boolean;
  error: string | null;
  
  // Actions
  createDiscovery: (data: DiscoveryInput) => Promise<void>;
  createDiscoveryWithLLM: (data: DiscoveryInput) => Promise<void>;
  fetchDiscoveries: () => Promise<void>;
  retryProcessing: (discoveryId: string) => Promise<void>;
  updateDiscovery: (id: string, data: Partial<Discovery>) => Promise<void>;
  deleteDiscovery: (id: string) => Promise<void>;
  clearError: () => void;
  
  // Future queue actions (commented for MVP)
  /*
  queueItems: QueueItem[];
  processQueue: () => Promise<void>;
  addToQueue: (discoveryId: string) => Promise<void>;
  getQueueStatus: () => Promise<void>;
  */
}
```

### Phase 5: Configuration for Future Scalability

#### Processing Configuration
- **File**: `config/processing.ts`
- **Changes**: Create configuration for processing modes
```typescript
export const PROCESSING_CONFIG = {
  // MVP: Immediate processing
  mode: 'immediate' as 'immediate' | 'queue',
  
  // LLM configuration
  llm: {
    timeout: 30000, // 30 seconds
    maxRetries: 3,
    retryDelay: 5000,
    model: 'gpt-4o-mini' as 'gpt-4o-mini' | 'gemini-flash'
  },
  
  // Future: Queue configuration (commented for MVP)
  /*
  queue: {
    enabled: false,
    batchSize: 10,
    retryAttempts: 3,
    retryDelay: 5000,
    priorityLevels: ['high', 'normal', 'low']
  }
  */
};
```

## Algorithms

### LLM Processing Flow (MVP: Immediate)
1. **Discovery Creation**: User creates discovery
2. **Immediate LLM Processing**: Send text + image to LLM API
3. **Entity Extraction**: Extract keywords, entities, sub-types
4. **Data Validation**: Validate extracted data
5. **Database Update**: Save extracted data to discovery
6. **UI Update**: Update timeline with extracted data

### LLM Integration Algorithm
1. **Input Preparation**: Combine text content with image description
2. **Prompt Creation**: Generate structured prompt for entity extraction
3. **API Call**: Send to GPT-4o Mini or Gemini Flash
4. **Response Parsing**: Extract JSON structure from LLM response
5. **Data Validation**: Validate extracted entities and confidence scores
6. **Storage**: Save structured data to JSONB column

### Error Handling Algorithm (MVP)
1. **Error Detection**: Catch LLM API errors
2. **Retry Logic**: Retry failed requests with exponential backoff
3. **Fallback**: Save discovery without LLM data if all retries fail
4. **User Notification**: Show error message with retry option
5. **Manual Retry**: Allow user to retry processing

### Future Queue Processing Flow (Commented for MVP)
/*
1. **Discovery Creation**: User creates discovery
2. **Queue Addition**: Add to processing queue
3. **Background Processing**: Process queue when online
4. **Batch Processing**: Process multiple items efficiently
5. **Retry Logic**: Automatic retry with backoff
6. **Sync**: Sync with remote database
7. **UI Update**: Update timeline with processed data
*/

## Files to Create/Modify

### New Files
- `services/llmService.ts`
- `components/discovery/ProcessingStatus.tsx`
- `config/processing.ts`

### Modified Files
- `services/discoveryService.ts` - Add LLM processing
- `stores/discoveryStore.ts` - Add processing state
- `components/discovery/DiscoveryCard.tsx` - Add extracted data display
- `app/(tabs)/create.tsx` - Add processing feedback
- `app/(tabs)/discoveries.tsx` - Show extracted data
- `types/discovery.ts` - Add LLM types

### Dependencies to Add
```json
{
  "openai": "latest"
}
```

## Success Criteria
- [ ] LLM processes discoveries immediately after creation
- [ ] Extracted data is displayed in discovery cards
- [ ] Processing status is shown to users
- [ ] Failed processing can be retried manually
- [ ] Extracted data enhances discovery experience
- [ ] LLM processing has timeout and error handling
- [ ] Configuration allows easy switching to queue mode
- [ ] Database schema supports future queue system
- [ ] Type definitions are ready for queue integration
- [ ] Processing doesn't block user interaction (with proper loading states) 